---
- name: Ensure required packages for Input Leap are installed
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
    update_cache: true
  loop:
    - desktop-file-utils
    - libavahi-compat-libdnssd-dev
    - libx11-dev
    - libxtst-dev
    - libxinerama-dev
    - libxrandr-dev
    - libice-dev
    - libsm-dev
    - libssl-dev
    - libgl1-mesa-dev
    - libglu1-mesa-dev
    - mesa-common-dev
  tags:
    - packages

- name: Ensure OpenGL dependencies are installed
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
    update_cache: true
  loop:
    - libgl1-mesa-dev
    - libglu1-mesa-dev
    - mesa-common-dev
  tags:
    - opengl

- name: Clone Input Leap repository
  ansible.builtin.git:
    repo: https://github.com/input-leap/input-leap.git
    dest: /opt/input-leap
    version: HEAD
    recursive: yes # Ensures submodules are cloned
  tags:
    - input-leap

- name: Create build directory for Input Leap
  ansible.builtin.file:
    path: /opt/input-leap/build
    state: directory
  tags:
    - build

- name: Set environment variable for Qt6
  ansible.builtin.shell: |
    export Qt6_DIR="/usr/local/Qt-{{ qt6_subversion }}/lib/cmake/Qt6"
    cmake -S. -Bbuild
  args:
    chdir: /opt/input-leap
  tags:
    - build

- name: Compile Input Leap
  ansible.builtin.command:
    cmd: cmake --build build
    chdir: /opt/input-leap
  tags:
    - build

- name: Install Input Leap
  ansible.builtin.command:
    cmd: cmake --install build
    chdir: /opt/input-leap
  tags:
    - install

- name: Ensure SSL directory exists
  ansible.builtin.file:
    path: /root/.local/share/InputLeap/SSL
    state: directory
    mode: "0755"
  tags:
    - ssl

- name: Ensure Fingerprints directory exists
  ansible.builtin.file:
    path: /root/.local/share/InputLeap/SSL/Fingerprints
    state: directory
    mode: "0755"
  tags:
    - ssl

- name: Generate a temporary SSL certificate if it doesn't exist
  ansible.builtin.shell: |
    openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
    -keyout /root/.local/share/InputLeap/SSL/InputLeap.key \
    -out /root/.local/share/InputLeap/SSL/InputLeap.pem \
    -subj "/CN=InputLeap"
  args:
    creates: /root/.local/share/InputLeap/SSL/InputLeap.pem
  tags:
    - ssl
