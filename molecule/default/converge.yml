---
- name: Converge
  hosts: all
  become: true
  gather_facts: true
  strategy: free
  vars:
    default_user: "{{ lookup('env', 'USER') | default('default_user') }}"

  roles:
    - role: "$PWD/roles/ansible-playbook"
      tags: 
        - always

  handlers:
    - include_tasks: "$PWD/roles/ansible-playbook/handlers/main.yml"

  post_tasks:
    - name: Check disk space usage after convergence
      ansible.builtin.shell: df -h
      register: disk_usage

    - name: Display disk usage information
      ansible.builtin.debug:
        msg: "{{ disk_usage.stdout }}"

    - name: Verify if any important services are down
      ansible.builtin.service_facts:
      when: ansible_virtualization_type != "docker"

    - name: Display the status of critical services
      ansible.builtin.debug:
        msg: "{{ item.key }} is in state {{ item.value.state }}"
      loop: "{{ ansible_facts.services | dict2items }}"
      when:
        - ansible_virtualization_type != "docker"
        - item.value.state != 'running'